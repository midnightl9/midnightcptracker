<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
  import {
    getDatabase,
    ref,
    get,
    push,
    set,
    update,
    remove,
    onValue
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

  // Admin auth only
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA_C0Z-y3CjTFXeWTmvrK7y7cne1jlGbko",
    authDomain: "cptracker-a0f52.firebaseapp.com",
    databaseURL: "https://cptracker-a0f52-default-rtdb.firebaseio.com",
    projectId: "cptracker-a0f52",
    storageBucket: "cptracker-a0f52.firebasestorage.app",
    messagingSenderId: "502447144576",
    appId: "1:502447144576:web:7d5099ed4095f2bf9db065",
    measurementId: "G-5TDM69JFJZ"
  };

  const app = initializeApp(firebaseConfig);
  getAnalytics(app);
  const db = getDatabase(app);

  const membersRootRef = ref(db, "members");

  // âœ… Admin Auth
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // ðŸ”’ Replace with your admin UID(s)
  const ADMIN_UIDS = [
    "nztkDC7sYqTeB8uQ55x5vB8p0lf2"
    // "SECOND_ADMIN_UID_HERE"
  ];

  const adminLoginBtn = document.getElementById("adminLoginBtn");
  const adminLogoutBtn = document.getElementById("adminLogoutBtn");

  adminLoginBtn.addEventListener("click", async () => {
    try {
      await signInWithPopup(auth, provider);
    } catch (e) {
      console.error(e);
      alert("Admin login failed: " + (e?.message || e));
    }
  });

  adminLogoutBtn.addEventListener("click", async () => {
    try {
      await signOut(auth);
    } catch (e) {
      console.error(e);
      alert("Logout failed: " + (e?.message || e));
    }
  });

  function isAdminUser(user) {
    return !!user && ADMIN_UIDS.includes(user.uid);
  }

  onAuthStateChanged(auth, (user) => {
    const isAdmin = isAdminUser(user);

    if (user) {
      adminLoginBtn.classList.add("hidden");
      adminLogoutBtn.classList.remove("hidden");
    } else {
      adminLoginBtn.classList.remove("hidden");
      adminLogoutBtn.classList.add("hidden");
    }

    const adminTools = document.getElementById("admin-only-tools");
    if (adminTools) adminTools.style.display = isAdmin ? "block" : "none";

    console.log("Logged in:", user?.email, user?.uid, "isAdmin:", isAdmin);
  });

  const defaultAvatars = {
    Bow: "https://i.imgur.com/w8VJlOnm.jpg",
    Crossbow: "https://i.imgur.com/Omci8iCm.jpg",
    Staff: "https://i.imgur.com/Bo3ZY5vm.jpg",
    "Battle Shield": "https://i.imgur.com/YCpmOwTm.jpg",
    "Great Sword": "https://i.imgur.com/IHsuu5am.jpg",
    "Battle Staff": "https://i.imgur.com/xI1IKPsm.jpg",
    "Sword & Shield": "https://i.imgur.com/I4Rku2cm.jpg",
    Dagger: "https://i.imgur.com/fzTxuszm.jpg",
    "Bare Hand": "https://i.imgur.com/Bo3ZY5vm.jpg"
  };

  let membersCache = [];
  let activeClassFilter = "ALL";

  // âœ… Stable week key + display label
  function toISODate(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function getWeekMeta() {
    const now = new Date();
    const day = now.getDay(); // 0=Sun

    const sunday = new Date(now);
    sunday.setHours(0, 0, 0, 0);
    sunday.setDate(now.getDate() - day);

    const saturday = new Date(sunday);
    saturday.setDate(sunday.getDate() + 6);

    const format = (d) =>
      d.toLocaleDateString("en-US", { month: "short", day: "numeric" });

    return {
      weekKey: toISODate(sunday), // stable grouping key
      weekLabel: `${format(sunday)} - ${format(saturday)}` // pretty display
    };
  }

  async function fetchMembers() {
    const snap = await get(membersRootRef);
    const val = snap.val() || {};
    return Object.entries(val).map(([id, data]) => ({ id, ...data }));
  }

  async function populateMemberDropdowns() {
    const select = document.getElementById("update-member-select");
    if (!select) return;

    select.innerHTML = '<option value="">Select Member</option>';
    const list = await fetchMembers();

    list.forEach((m) => {
      const option = document.createElement("option");
      option.value = m.id;
      option.textContent = m.name;
      select.appendChild(option);
    });
  }

  function renderClassFilters() {
    const wrap = document.getElementById("class-filters");
    const classes = ["ALL", ...new Set(membersCache.map((m) => m.class))];

    wrap.innerHTML = classes
      .map((cls) => {
        const isActive = cls === activeClassFilter;
        return `
          <button class="px-3 py-1 rounded-full text-sm border ${
            isActive
              ? "bg-yellow-500 text-gray-900 border-yellow-400"
              : "bg-gray-800 text-white border-gray-700"
          }"
            data-class="${cls}">${cls}</button>
        `;
      })
      .join("");

    wrap.querySelectorAll("button").forEach((btn) => {
      btn.addEventListener("click", () => {
        activeClassFilter = btn.dataset.class;
        renderMembersGrid();
      });
    });
  }

  let guildChartInstance = null;

  function renderGuildWeeklyChart() {
    const canvas = document.getElementById("guildProgressChart");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");

    // âœ… Group by stable weekKey; keep label for display
    const weekMap = new Map(); // weekKey -> { label, total }
    membersCache.forEach((m) => {
      const list = Array.isArray(m.weeklyCP) ? m.weeklyCP : [];
      list.forEach((w) => {
        const key = w.weekKey || w.week; // backward compatible
        if (!key) return;

        const label = w.weekLabel || w.week || key;
        const cur = weekMap.get(key) || { label, total: 0 };
        cur.total += Number(w.cp) || 0;
        cur.label = label;
        weekMap.set(key, cur);
      });
    });

    const keys = Array.from(weekMap.keys()).sort(); // stable chronological sort
    const labels = keys.map((k) => weekMap.get(k)?.label || k);
    const data = keys.map((k) => weekMap.get(k)?.total || 0);

    if (guildChartInstance) guildChartInstance.destroy();
    guildChartInstance = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Guild Total CP",
            data,
            borderColor: "#60a5fa",
            backgroundColor: "rgba(96,165,250,0.12)",
            tension: 0.35,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: false },
          x: { grid: { color: "rgba(255,255,255,0.1)" } }
        }
      }
    });
  }

  function renderMembersGrid() {
    const grid = document.getElementById("members-grid");
    const list =
      activeClassFilter === "ALL"
        ? membersCache
        : membersCache.filter((m) => m.class === activeClassFilter);

    grid.innerHTML = list
      .map(
        (m) => `
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-400 cursor-pointer hover:shadow-xl transition-all" data-id="${m.id}">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <img src="${m.avatar || defaultAvatars[m.class]}" alt="${m.name}" class="w-12 h-12 rounded-full">
              <div>
                <h4 class="font-bold">${m.name}</h4>
                <span class="class-badge ${m.classColor || "bg-gray-500"} text-white">${m.class}</span>
              </div>
            </div>
            <div class="achievement-badge bg-yellow-500 text-gray-900 rounded-full p-2">
              <i data-feather="star"></i>
            </div>
          </div>
          <div class="mb-4">
            <div class="flex justify-between text-sm mb-1">
              <span>Current CP: ${(Number(m.cp) || 0).toLocaleString()}</span>
              <span class="text-green-400">${(Number(m.growth) || 0) >= 0 ? "+" : ""}${(Number(m.growth) || 0).toLocaleString()}</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2">
              <div class="cp-progress-bar bg-green-500 h-2 rounded-full" style="width:${Math.min(
                100,
                ((Number(m.cp) || 0) / 20000) * 100
              )}%"></div>
            </div>
          </div>
        </div>
      `
      )
      .join("");

    grid.querySelectorAll("[data-id]").forEach((card) => {
      card.addEventListener("click", () => viewMember(card.dataset.id));
    });

    feather.replace();
  }

  // âœ… Real-time sync (this is the big fix)
  function startMembersListener() {
    onValue(membersRootRef, (snap) => {
      const val = snap.val() || {};
      membersCache = Object.entries(val).map(([id, data]) => ({ id, ...data }));

      document.getElementById("total-members").textContent = membersCache.length;

      document.getElementById("avg-cp").textContent = membersCache.length
        ? Math.round(
            membersCache.reduce((a, b) => a + (Number(b.cp) || 0), 0) /
              membersCache.length
          ).toLocaleString()
        : "0";

      document.getElementById("top-growth").textContent = membersCache.length
        ? Math.max(...membersCache.map((m) => Number(m.growth) || 0)).toLocaleString()
        : "0";

      document.getElementById("active-classes").textContent =
        [...new Set(membersCache.map((m) => m.class))].length + "/9";

      renderClassFilters();
      renderMembersGrid();
      renderGuildWeeklyChart();
      feather.replace();

      // keep dropdown synced for admins
      populateMemberDropdowns();
    });
  }

  // âœ… Add Member (EVERYONE can create)
  document.getElementById("add-member-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = document.getElementById("new-member-name").value.trim();
    const cls = document.getElementById("new-member-class").value;
    const cp = parseInt(document.getElementById("new-member-cp").value, 10);
    let avatar = document.getElementById("new-member-avatar").value.trim();

    if (!avatar) avatar = defaultAvatars[cls] || defaultAvatars["Bare Hand"];
    const color =
      document.querySelector(`#new-member-class option[value="${cls}"]`)?.dataset
        .color || "bg-gray-500";

    if (!name || !cls || Number.isNaN(cp)) return alert("Fill all fields");

    const existing = await fetchMembers();
    const exists = existing.some(
      (m) => (m.name || "").toLowerCase() === name.toLowerCase() && m.class === cls
    );
    if (exists) return alert("Member exists!");

    const { weekKey, weekLabel } = getWeekMeta();

    const newRef = push(membersRootRef);
    await set(newRef, {
      name,
      class: cls,
      classColor: color,
      cp,
      growth: 0,
      weeklyCP: [{ weekKey, weekLabel, cp, growth: 0 }],
      avatar
    });

    alert("Member added!");
    e.target.reset();
    // no need to call loadMembers(); realtime listener updates everyone
  });

  // âœ… Update CP (Admin only via rules + UI hidden)
  document.getElementById("update-cp-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const id = document.getElementById("update-member-select").value;
    const newCP = parseInt(document.getElementById("update-cp-value").value, 10);
    if (!id || Number.isNaN(newCP)) return alert("Select member and enter CP");

    try {
      const memberRef = ref(db, `members/${id}`);
      const snap = await get(memberRef);
      if (!snap.exists()) return alert("Member not found!");

      const data = snap.val();
      const prevCP = Number(data.cp) || 0;
      const growth = newCP - prevCP;

      const { weekKey, weekLabel } = getWeekMeta();

      let weeklyCP = Array.isArray(data.weeklyCP) ? [...data.weeklyCP] : [];

      // âœ… match by weekKey (stable)
      const existing = weeklyCP.find((w) => (w.weekKey || w.week) === weekKey);
      if (existing) {
        existing.cp = newCP;
        existing.growth = growth;
        existing.weekKey = weekKey;
        existing.weekLabel = weekLabel;
      } else {
        weeklyCP.push({ weekKey, weekLabel, cp: newCP, growth });
      }

      if (weeklyCP.length > 4) weeklyCP = weeklyCP.slice(-4);

      await update(memberRef, { cp: newCP, growth, weeklyCP });

      alert(
        `Updated CP to ${newCP} (Growth: ${growth >= 0 ? "+" : ""}${growth})`
      );
      document.getElementById("update-cp-value").value = "";
      // realtime listener updates UI
    } catch (err) {
      console.error("UPDATE FAILED:", err);
      alert("Update failed: " + (err?.message || err));
    }
  });

  // âœ… Delete Member (Admin only via rules + UI hidden)
  document.getElementById("delete-member-btn").addEventListener("click", async () => {
    const id = document.getElementById("update-member-select").value;
    if (!id) return alert("Select member");
    if (!confirm("Delete member?")) return;

    try {
      await remove(ref(db, `members/${id}`));
      alert("Deleted");
      // realtime listener updates UI
    } catch (err) {
      console.error("DELETE FAILED:", err);
      alert("Delete failed: " + (err?.message || err));
    }
  });

  // Modal chart
  let modalChartInstance = null;

  function viewMember(id) {
    const m = membersCache.find((x) => x.id === id);
    if (!m) return;

    document.getElementById("modalAvatar").src = m.avatar || defaultAvatars[m.class];
    document.getElementById("modalName").textContent = m.name;
    document.getElementById("modalClass").textContent = m.class;
    document.getElementById("modalCP").textContent = (Number(m.cp) || 0).toLocaleString();
    document.getElementById("modalGrowth").textContent =
      (Number(m.growth) || 0) >= 0 ? "+" : "";
    document.getElementById("modalGrowth").textContent += (Number(m.growth) || 0).toLocaleString();

    const ctx = document.getElementById("modalChart").getContext("2d");

    const weeks = (m.weeklyCP || []).map((w) => w.weekLabel || w.week || w.weekKey);
    const cpValues = (m.weeklyCP || []).map((w) => w.cp);

    if (modalChartInstance) modalChartInstance.destroy();
    modalChartInstance = new Chart(ctx, {
      type: "line",
      data: {
        labels: weeks,
        datasets: [
          {
            label: "CP",
            data: cpValues,
            borderColor: "#fbbf24",
            backgroundColor: "rgba(251,191,36,0.15)",
            tension: 0.4,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: false },
          x: { grid: { color: "rgba(255,255,255,0.1)" } }
        }
      }
    });

    document.getElementById("memberModal").classList.remove("hidden");
    document.getElementById("memberModal").classList.add("flex");
  }
  window.viewMember = viewMember;

  document.getElementById("closeModal").addEventListener("click", () => {
    document.getElementById("memberModal").classList.add("hidden");
    document.getElementById("memberModal").classList.remove("flex");
  });

  document.getElementById("memberModal").addEventListener("click", (e) => {
    if (e.target.id === "memberModal") {
      document.getElementById("memberModal").classList.add("hidden");
      document.getElementById("memberModal").classList.remove("flex");
    }
  });

  // Init
  feather.replace();
  startMembersListener();
</script>
